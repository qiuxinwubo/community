; (function($) {
    var imgArr = "";
    var retadr = "";
    var htmls = '<div class="item-bg"><div class="item" ><div class="item-inner"><div class="item-loader-container"><div class="la-ball-fussion la-2x"><div></div><div></div><div></div><div></div></div></div></div><div class="item-title">图片正在处理中...</div></div></div>';
    var htmls1 = '<div class="item-bg"><div class="item" ><div class="item-inner"><div class="item-loader-container"><div class="la-ball-fussion la-2x"><div></div><div></div><div></div><div></div></div></div></div><div class="item-title">图片上传中...</div></div></div>';
    var json = "";
    $.fulongImgLrz = function(file, path, code, base, returnFun, code1) {
        return fulongImgLrz(file, path, code, base, returnFun, code1)
    };
    $.fulongImgLrzEidtor = function(file, path, code, base, returnFun, code1) {
        return fulongImgLrzEidtor(file, path, code, base, returnFun, code1)
    };
    $.checkImgType = function(file, retResult) {
        return checkImgType(file, retResult)
    };
    /**
     * 上传图片进入口
     * @param file
     * @param path
     * @param code
     * @param base
     * @param returnFun
     * @param code1
     */
    fulongImgLrz = function(file, path, code, base, returnFun, code1) {
          var imgwidth="", imgheigth="", imgsize;
          imgsize = file.size;
          //console.log(imgwidth + "," + imgheigth + "," + (imgsize / 1024 / 1024).toFixed(2));
          var reader = new FileReader();
          reader.readAsDataURL(file);
          reader.onload = function() {
              var img = new Image();
              var imgData = reader.result;
              img.src = imgData;
              img.onload = function() {
                  imgwidth = img.width;
                  imgheigth = img.height;
                  fulongImgLrz1(file, path, code, base, returnFun, code1,"");
                 
              }
          }
          /*if((imgsize / 1024 / 1024).toFixed(2)>1)
          {
        	  fulongImgLrz1(file, path, code, base, returnFun, code1);
          }else
          {
        	  fulongImgLrz2(file, path, code, base, returnFun, code1);
          }*/
    }
     /**
      * 处理图片
      * @param file
      * @param path
      * @param code
      * @param base
      * @param returnFun
      * @param code1
      */
    fulongImgLrz2 = function(file, path, code, base, returnFun, code1) {
    	retadr = returnFun;
    	//console.log(file);
        $(".item-bg").remove();
        $("body").append(htmls1);
        var reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = function(e) {
            var jsonstrResult = "[]";
            var jsonstrResult = "[]";
            var jsonstrResultB = '{"dataUrl":[';
            var jsonstrResultE = ']}';
            var jsonstrResultC = "";
            var jsonarrayResult = eval('(' + jsonstrResult + ')');
            var json_new = JSON.parse(ajaxJson(base, code));
            for (var i = 0; i < json_new.imgData.length; i++) {
            	  jsonarrayResult.push(convertBase64UrlToBlob(this.result));
                        if (i == json_new.imgData.length-1) {
                        	//$(".item-bg").remove();
                            //$("body").append(htmls1);
                            ajaxblob(jsonarrayResult, json_new, path, base, code1);
                        }
            }
        }
    };
    /**
     * 不处理图片
     * @param file
     * @param path
     * @param code
     * @param base
     * @param returnFun
     * @param code1
     */
    fulongImgLrz1 = function(file, path, code, base, returnFun, code1,iflterone) {
    	retadr = returnFun;
    	var j=0;
    	var ifnone=iflterone;
    	//console.log(file);
        $(".item-bg").remove();
        $("body").append(htmls);
        var reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = function(e) {
            var jsonstrResult = "[]";
            var jsonstrResult = "[]";
            var jsonstrResultB = '{"dataUrl":[';
            var jsonstrResultE = ']}';
            var jsonstrResultC = "";
            var jsonarrayResult = eval('(' + jsonstrResult + ')');
            var json_new = JSON.parse(ajaxJson(base, code));            
            var oneresult = this.result;
            for (var i = 0; i < json_new.imgData.length; i++) {
                lrz(this.result, {
                    width: json_new.imgData[i].width,
                    height: json_new.imgData[i].height,
                    quality: json_new.imgData[i].quality,
                    before: function() {},
                    fail: function(err) {
                        console.error("error:" + err)
                    },
                    always: function() {
                        if (jsonarrayResult.length == json_new.imgData.length) {
                        	$(".item-bg").remove();
                            $("body").append(htmls1);
                            ajaxblob(jsonarrayResult, json_new, path, base, code1);
                        }
                    },
                    done: function(results) {
                    	//console.log(convertBase64UrlToBlob(results.base64));
                    	j++;
                    	if(ifnone=="one"&&j==1)
                    	{
                    		//alert(this.result)
                    		jsonarrayResult.push(convertBase64UrlToBlob(oneresult));		
                    	}else
                    	{
                    		jsonarrayResult.push(convertBase64UrlToBlob(results.base64));
                    	}
                        var a = ",";
                        if (jsonarrayResult.length == json_new.imgData.length) {
                            a = ""
                        };
                        jsonstrResultC = jsonstrResultC + '{"value" :"' + results.base64 + '"}' + a;
                        var arr = {
                            "value": results.base64
                        }
                    }
                })
            }
        }
    };
    /**
     * 编辑器上传
     * @param file
     * @param path
     * @param code
     * @param base
     * @param returnFun
     * @param code1
     */
    fulongImgLrzEidtor = function(file, path, code, base, returnFun, code1) {
    	retadr = returnFun;
        $(".item-bg").remove();
        $("body").append(htmls1);
        var reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = function(e) {
            var jsonstrResult = "[]";
            var jsonstrResult = "[]";
            var jsonstrResultB = '{"dataUrl":[';
            var jsonstrResultE = ']}';
            var jsonstrResultC = "";
            var jsonarrayResult = eval('(' + jsonstrResult + ')');
            var json_new = JSON.parse(ajaxJson(base, code));
            for (var i = 0; i < json_new.imgData.length; i++) {
                       //$(".item-bg").remove();
                       //$("body").append(htmls1);
                       jsonarrayResult.push(convertBase64UrlToBlob(this.result));
                       ajaxblob(jsonarrayResult, json_new, path, base, code1);
            }
        }
    };
    /**
     * ajax blob 形式图片相关数据提交
     * @param para
     * @param para1
     * @param para2
     * @param para3
     * @param para4
     */
    ajaxblob = function(para, para1, para2, para3, para4){
    	for(var i=0;i<para.length;i++)
  	   {
    		ajax(para[i],para1, para2, para3,para4,i);
  	   }
    };
    /**
     * ajax base64 形式提交图片相关数据
     * @param para
     * @param para1
     * @param para2
     * @param para3
     * @param para4
     */
    ajaxBase64 = function(para, para1, para2, para3, para4){
    	 var json_para = JSON.parse(para);
         $.ajax({
             type: "post",
             url: para3 + "/image/imgLtr.action",
             data: {
                 "dataUrl": JSON.stringify(json_para),
                 "imgData": JSON.stringify(para1),
                 "imgPath": para2,
                 "code": para4
             },
             async: true,
             success: function(data) {
                 imgArr = data;
                 retadr(imgArr);
                 $(".item-bg").remove();
             }
         });
    };
    /**
     * blob ajax提交
     * @param para 图片 blob 对象
     * @param para1 图片压缩相关数据
     * @param para2 图片存入地址
     * @param para3 名字
     * @param para4 第几个对象
     */
    ajax = function(para, para1, para2, para3, para4,para5) {
    	  var str = "?imgData="+JSON.stringify(para1)+"&imgPath="+para2+"&code="+para4+"&order="+para5;
    	  var xhr = new XMLHttpRequest();
    	  xhr.open('POST', para3 + "/image/imgLtr.action"+str, true);
    	  xhr.onload = function(e) { 
    		  console.log(xhr.responseText);
    		  if(xhr.responseText!=""){
		    	  imgArr = xhr.responseText;
		    	  retadr(imgArr);
		    	  $(".item-bg").remove();
    		  }
	      };
    	  xhr.send(para);
    };
    /**
     * 获取图片压缩质量尺寸相关数据
     * @param para
     * @param para1
     * @returns {String}
     */
    ajaxJson = function(para, para1) {
        $.ajax({
            type: "post",
            url: para + "/show.action?code=imgltr&name=" + para1,
            async: false,
            success: function(data) {
                json = data;
                if (JSON.parse(json).imgData.length == 0) {
                    console.log("%c" + para1 + ":在数据没有找到相关设置,请检查数据表EC_IMAGE_STYLE", "color:red")
                }
            }
        });
        return json;
    };
    var agent = navigator.userAgent.toLowerCase();
    checkImgType = function(ths, retResult) {
        var imgwidth="", imgheigth="", imgsize;
        imgsize = ths.size;
        //console.log(imgwidth + "," + imgheigth + "," + (imgsize / 1024 / 1024).toFixed(2));
        var reader = new FileReader();
        reader.readAsDataURL(ths);
        reader.onload = function() {
            var img = new Image();
            var imgData = reader.result;
            img.src = imgData;
            img.onload = function() {
                imgwidth = img.width;
                imgheigth = img.height;
                retResult(imgwidth + "," + imgheigth + "," + (imgsize / 1024 / 1024).toFixed(2), ths);
            }
        }
    }
    /**
     * 将以base64的图片url数据转换为Blob
     * @param urlData
     *            用url方式表示的base64图片数据
     */
    function convertBase64UrlToBlob(urlData){
        var bytes=window.atob(urlData.split(',')[1]);        //去掉url的头，并转换为byte
        //处理异常,将ascii码小于0的转换为大于0
        var ab = new ArrayBuffer(bytes.length);
        var ia = new Uint8Array(ab);
        for (var i = 0; i < bytes.length; i++) {
            ia[i] = bytes.charCodeAt(i);
        }
        return new Blob( [ab] , {type : 'image/png'});
    }
})(jQuery)